<!-- Page Content with Animation -->
<div [@pageFadeIn]>
  <!-- Search and Filters Bar -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="flex items-center gap-4">
      <!-- Status Filter -->
      <div class="flex items-center space-x-2">
        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Status:</label>
        <select 
          [(ngModel)]="statusFilter"
          (ngModelChange)="onStatusFilterChange()"
          class="w-32 pl-3 pr-8 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-sm font-medium text-gray-700 shadow-sm hover:border-gray-400 transition-colors duration-200 appearance-none cursor-pointer">
          <option value="all">All</option>
          <option value="active">Active</option>
          <option value="expired">Expired</option>
        </select>
      </div>

      <!-- Coupon Number Filter -->
      <div class="flex items-center space-x-2">
        <label class="text-sm font-medium text-gray-700">By Coupon Number:</label>
        <input 
          type="text" 
          [(ngModel)]="couponNumberFilter"
          (ngModelChange)="onCouponNumberFilterChange()"
          placeholder="Search by coupon number..."
          class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
    </div>
  </div>

  <!-- Service Redemption Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Code
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Customer
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Services (Used/Total)
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Expiry Date
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Action
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let coupon of filteredCoupons" class="hover:bg-gray-50">
            <!-- Code Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ coupon.code }}</div>
            </td>

            <!-- Customer Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ coupon.customer }}</div>
            </td>

            <!-- Services Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <span class="font-medium">{{ coupon.servicesUsed }}</span>
                <span class="text-gray-500">/</span>
                <span class="font-medium">{{ coupon.servicesTotal }}</span>
              </div>
            </td>

            <!-- Expiry Date Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ formatDate(coupon.expiryDate) }}</div>
            </td>

            <!-- Status Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                    [class]="getStatusBadgeClass(coupon.status)">
                <i class="bi bi-circle-fill text-xs mr-1"></i>
                {{ coupon.status }}
              </span>
            </td>

            <!-- Action Column -->
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button 
                (click)="redeemService(coupon)"
                [disabled]="coupon.status === 'Expired'"
                [class]="coupon.status === 'Expired' ? 
                  'text-gray-400 bg-gray-100 px-3 py-1 rounded-md cursor-not-allowed' : 
                  'text-blue-600 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-md transition-colors duration-200'">
                {{ coupon.status === 'Expired' ? 'Expired' : 'Redeem Service' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- No Results Message -->
    <div *ngIf="filteredCoupons.length === 0" class="text-center py-8">
      <div class="text-gray-500">
        <i class="bi bi-search text-4xl mb-2"></i>
        <p>No service redemptions found matching your filters.</p>
      </div>
    </div>
  </div>

  <!-- OTP Verification Dialog -->
  <div 
    *ngIf="showOtpDialog" 
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
    (click)="closeOtpDialog()">
    <div 
      class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-md bg-white"
      (click)="$event.stopPropagation()">
      
      <!-- Dialog Header -->
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Verification Required</h3>
        <button 
          (click)="closeOtpDialog()"
          class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Dialog Body -->
      <div class="mb-6">
        <!-- Coupon Info -->
        <div class="bg-gray-50 p-3 rounded-lg mb-4">
          <p class="font-medium text-gray-900">Coupon: {{ selectedCoupon?.code }}</p>
          <p class="text-sm text-gray-600">Customer: {{ selectedCoupon?.customer }}</p>
        </div>

        <!-- Step 1: OTP Delivery Method Selection -->
        <div *ngIf="verificationStep === 'select'">
          <p class="text-gray-700 mb-4">Please choose how you want to receive the OTP for service redemption.</p>
          
          <!-- OTP Delivery Method Selection -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-3">OTP Delivery Method</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input 
                  type="radio" 
                  name="verificationMethod" 
                  value="otp" 
                  [(ngModel)]="verificationMethod"
                  (change)="onVerificationMethodChange()"
                  class="mr-2 text-blue-600 focus:ring-blue-500">
                <span class="text-sm text-gray-700">SMS OTP (Mobile Number)</span>
              </label>
              <label class="flex items-center">
                <input 
                  type="radio" 
                  name="verificationMethod" 
                  value="email" 
                  [(ngModel)]="verificationMethod"
                  (change)="onVerificationMethodChange()"
                  class="mr-2 text-blue-600 focus:ring-blue-500">
                <span class="text-sm text-gray-700">Email OTP</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Step 2: OTP Verification -->
        <div *ngIf="verificationStep === 'verify'">
          <p class="text-gray-700 mb-4">
            {{ verificationMethod === 'otp' ? 
              'Please enter the 6-digit OTP sent to your registered mobile number.' : 
              'Please enter the 6-digit OTP sent to your registered email address.' }}
          </p>

          <!-- OTP Input -->
          <div class="mb-4">
            <label for="otpCode" class="block text-sm font-medium text-gray-700 mb-2">Enter 6-digit OTP</label>
            <input 
              type="text" 
              id="otpCode"
              [(ngModel)]="otpCode"
              maxlength="6"
              placeholder="123456"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono tracking-widest"
              (input)="onOtpInput($event)">
            <div class="text-xs text-gray-500 text-center mt-2">
              <p>For demo purposes, enter any 6-digit number</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Dialog Footer -->
      <div class="flex justify-end space-x-3">
        <button
          (click)="closeOtpDialog()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
          Cancel
        </button>
        
        <!-- Step 1: Send OTP Button -->
        <button
          *ngIf="verificationStep === 'select'"
          (click)="sendVerification()"
          [disabled]="isSending"
          class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          style="background-color: var(--button-primary-bg);"
          onmouseover="this.style.backgroundColor='var(--button-primary-hover)'"
          onmouseout="this.style.backgroundColor='var(--button-primary-bg)'"
          onfocus="this.style.backgroundColor='var(--button-primary-focus)'"
          onblur="this.style.backgroundColor='var(--button-primary-bg)'">
          <span *ngIf="isSending" class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending OTP...
          </span>
          <span *ngIf="!isSending">Send OTP</span>
        </button>

        <!-- Step 2: Verify OTP Button -->
        <button
          *ngIf="verificationStep === 'verify'"
          (click)="confirmOtp()"
          [disabled]="otpCode.length !== 6 || isOtpValidating"
          class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          style="background-color: var(--button-primary-bg);"
          onmouseover="this.style.backgroundColor='var(--button-primary-hover)'"
          onmouseout="this.style.backgroundColor='var(--button-primary-bg)'"
          onfocus="this.style.backgroundColor='var(--button-primary-focus)'"
          onblur="this.style.backgroundColor='var(--button-primary-bg)'">
          <span *ngIf="isOtpValidating" class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Verifying OTP...
          </span>
          <span *ngIf="!isOtpValidating">Verify OTP</span>
        </button>
      </div>
    </div>
  </div>
</div>
